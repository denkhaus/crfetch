package main

import (
	"fmt"
	"github.com/denkhaus/go-store"
	"github.com/denkhaus/yamlconfig"
)

type ProviderBase struct {
	store  *store.Store
	config *yamlconfig.Config
	self   Provider
	name   string
	pathId string
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// Name
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) Name() string {
	return p.name
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// FormatBarKey
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) FormatBarKey(symbolId int, snap int, barTs int) string {
	return fmt.Sprintf("/mkt/%s/bars/%d/%d/%d",
		p.pathId, symbolId, snap, barTs)
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// FormatPriceKey
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) FormatPriceKey(symbolId int) string {
	return fmt.Sprintf("%s/p", p.FormatSymbolIdPath(symbolId))
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// FormatVolumeKey
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) FormatVolumeKey(symbolId int) string {
	return ""
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// FormatTimestampPath
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) FormatSymbolIdPath(symbolId int) string {
	return fmt.Sprintf("%s/%d", p.GetQuotesPath(), symbolId)
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// GetQuotesPath
///////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) GetQuotesPath() string {
	return fmt.Sprintf("/mkt/%s/q", p.pathId)
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// GetPrice
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) GetPrice(ts int, symbolId int) (float64, error) {

	setName := p.self.FormatPriceKey(symbolId)
	price, err := p.store.SortedSetGet(setName, float64(ts))

	if err != nil {
		return 0.0, fmt.Errorf("get price error at set name %s and ts %d :: error:: %s",
		setName, ts, err.Error())
	}

	if price == nil && err == nil {
		return 0.0, fmt.Warnf("get price at set name %s and ts %d :: price entry not available",
		setName, ts)
	}

	return price, err
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// GetVolume
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
func (p *ProviderBase) GetVolume(ts int, symbolId int) (float64, error) {

	setName := p.self.FormatVolumeKey(symbolId)
	volume, err := p.store.SortedSetGet(setName, float64(ts))

	if err != nil {
		return 0.0, fmt.Errorf("get volume error at set name %s and ts %d :: error:: %s",
		setName, ts, err.Error())
	}

    // throw no error here since volume is not mandatory
	if price == nil && err == nil {
		return 0.0, nil
	}

	return volume, nil
}
